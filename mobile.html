<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‘é€å¼¹å¹•</title>
    <link rel="stylesheet" href="mobile.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± å¼¹å¹•å‘é€å™¨</h1>
            <p class="subtitle">å®æ—¶å‘é€å¼¹å¹•åˆ°è§†é¢‘æ’­æ”¾å™¨</p>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">è¿æ¥çŠ¶æ€</span>
                <span id="connectionStatus" class="status-value disconnected">æœªè¿æ¥</span>
            </div>
        </div>
        
        <div class="danmaku-section">
            <div class="input-group">
                <textarea 
                    id="danmakuInput" 
                    placeholder="è¾“å…¥å¼¹å¹•å†…å®¹..." 
                    maxlength="100"
                    rows="3"
                ></textarea>
                <div class="char-count">
                    <span id="charCount">0</span>/100
                </div>
            </div>
            
            <div class="color-picker">
                <p class="section-title">é€‰æ‹©å¼¹å¹•é¢œè‰²</p>
                <div class="color-options">
                    <button class="color-btn active" data-color="#FFFFFF" style="background: #FFFFFF; border: 2px solid #667eea;"></button>
                    <button class="color-btn" data-color="#FF0000" style="background: #FF0000;"></button>
                    <button class="color-btn" data-color="#00FF00" style="background: #00FF00;"></button>
                    <button class="color-btn" data-color="#0000FF" style="background: #0000FF;"></button>
                    <button class="color-btn" data-color="#FFFF00" style="background: #FFFF00;"></button>
                    <button class="color-btn" data-color="#FF00FF" style="background: #FF00FF;"></button>
                    <button class="color-btn" data-color="#00FFFF" style="background: #00FFFF;"></button>
                    <button class="color-btn" data-color="#FFA500" style="background: #FFA500;"></button>
                    <button class="color-btn" data-color="#FF69B4" style="background: #FF69B4;"></button>
                    <button class="color-btn" data-color="#98FB98" style="background: #98FB98;"></button>
                </div>
            </div>
            
            <button id="sendBtn" class="send-btn">
                <span class="btn-text">å‘é€å¼¹å¹•</span>
                <span class="btn-icon">ğŸš€</span>
            </button>
        </div>
        
        <div class="recent-danmaku">
            <p class="section-title">æœ€è¿‘å‘é€çš„å¼¹å¹•</p>
            <div id="recentList" class="recent-list">
                <p class="empty-message">æš‚æ— å‘é€è®°å½•</p>
            </div>
        </div>
        
        <div class="tips">
            <p>ğŸ’¡ æç¤ºï¼š</p>
            <ul>
                <li>å¼¹å¹•å°†åœ¨è§†é¢‘ä¸Šå®æ—¶æ»šåŠ¨æ˜¾ç¤º</li>
                <li>æ”¯æŒä¸­è‹±æ–‡è¾“å…¥</li>
                <li>æœ€å¤šè¾“å…¥100ä¸ªå­—ç¬¦</li>
                <li>è¯·æ–‡æ˜å‘è¨€ï¼Œå…±åˆ›è‰¯å¥½æ°›å›´</li>
            </ul>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    
    <script src="danmaku-client.js"></script>
    <script>
        // Initialize danmaku client
        const client = new DanmakuClient({
            useSSE: window.USE_SSE !== false, // Use SSE by default
            apiBase: window.API_BASE || window.location.origin,
            onMessage: handleDanmakuMessage,
            onConnect: handleConnect,
            onError: handleError,
            onDisconnect: handleDisconnect
        });

        // Track recent danmaku
        let recentDanmaku = [];
        const MAX_RECENT = 5;
        let selectedColor = '#FFFFFF';

        // Handle incoming messages (for feedback)
        function handleDanmakuMessage(data) {
            if (data.type === 'danmaku' && data.text) {
                console.log('Danmaku broadcast:', data.text);
            }
        }

        // Handle connection
        function handleConnect() {
            updateConnectionStatus('å·²è¿æ¥', 'connected');
            showToast('å·²è¿æ¥åˆ°å¼¹å¹•æœåŠ¡å™¨');
        }

        // Handle disconnection
        function handleDisconnect() {
            updateConnectionStatus('è¿æ¥æ–­å¼€', 'disconnected');
            showToast('è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...');
        }

        // Handle errors
        function handleError(error) {
            console.error('Danmaku client error:', error);
            updateConnectionStatus('è¿æ¥é”™è¯¯', 'error');
        }

        // Update connection status display
        function updateConnectionStatus(text, status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = text;
            statusEl.className = 'status-value ' + status;
        }

        // Show toast message
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Color picker functionality
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedColor = btn.dataset.color;
            });
        });

        // Character count
        const input = document.getElementById('danmakuInput');
        const charCount = document.getElementById('charCount');

        input.addEventListener('input', () => {
            charCount.textContent = input.value.length;
        });

        // Send danmaku
        document.getElementById('sendBtn').addEventListener('click', sendDanmaku);

        async function sendDanmaku() {
            const text = input.value.trim();
            
            if (!text) {
                showToast('è¯·è¾“å…¥å¼¹å¹•å†…å®¹');
                return;
            }
            
            if (!client.isConnected()) {
                showToast('æœªè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¨å€™');
                return;
            }

            try {
                await client.sendDanmaku(text, {
                    color: selectedColor,
                    fontSize: 24,
                    speed: 5,
                    position: 'random'
                });
                
                // Add to recent list
                addToRecentList(text, selectedColor);
                
                // Clear input
                input.value = '';
                charCount.textContent = '0';
                
                showToast('å¼¹å¹•å‘é€æˆåŠŸï¼');
                
            } catch (error) {
                console.error('Failed to send danmaku:', error);
                showToast('å‘é€å¤±è´¥: ' + error.message);
            }
        }

        // Add to recent danmaku list
        function addToRecentList(text, color) {
            recentDanmaku.unshift({ text, color, time: new Date() });
            
            if (recentDanmaku.length > MAX_RECENT) {
                recentDanmaku.pop();
            }
            
            updateRecentList();
        }

        // Update recent list display
        function updateRecentList() {
            const listEl = document.getElementById('recentList');
            
            if (recentDanmaku.length === 0) {
                listEl.innerHTML = '<p class="empty-message">æš‚æ— å‘é€è®°å½•</p>';
                return;
            }
            
            listEl.innerHTML = recentDanmaku.map(item => `
                <div class="recent-item">
                    <span class="recent-text" style="color: ${item.color};">${escapeHtml(item.text)}</span>
                    <span class="recent-time">${formatTime(item.time)}</span>
                </div>
            `).join('');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Format time
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            return Math.floor(diff / 86400000) + 'å¤©å‰';
        }

        // Initialize
        client.connect();
    </script>
</body>
</html>
